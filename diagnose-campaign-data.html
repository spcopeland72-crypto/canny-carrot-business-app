<!DOCTYPE html>
<html>
<head>
  <title>Diagnose Campaign Data</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; line-height: 1.6; }
    .section { margin: 20px 0; padding: 15px; background: #252526; border-radius: 5px; }
    .valid { color: #4ec9b0; }
    .invalid { color: #f48771; }
    .warning { color: #dcdcaa; }
    pre { background: #1e1e1e; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
    button { padding: 10px 20px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
    button:hover { background: #005a9e; }
    .campaign-item { margin: 10px 0; padding: 10px; background: #1e1e1e; border-left: 3px solid; }
    .campaign-valid { border-color: #4ec9b0; }
    .campaign-invalid { border-color: #f48771; }
  </style>
</head>
<body>
  <h1>üîç Campaign Data Diagnostic Tool</h1>
  <p>This tool reads ACTUAL data from localStorage and shows exactly what the app sees.</p>
  <button onclick="runDiagnostic()">Run Full Diagnostic</button>
  <button onclick="findStablesBingo()">Find "Stables bingo"</button>
  <div id="output"></div>

  <script>
    const campaignTypes = ['double_stamps', 'bonus_reward', 'flash_sale', 'referral', 'birthday', 'happy_hour', 'loyalty_tier'];
    const campaignStatuses = ['draft', 'scheduled', 'active', 'paused', 'completed', 'cancelled'];

    function validateCampaign(item) {
      // Check if it's a reward
      const isReward = item.isActive !== undefined || item.stampsRequired || item.costStamps;
      if (isReward) {
        return { valid: false, reason: 'Looks like a reward (has isActive/stampsRequired/costStamps)' };
      }
      
      // Check for campaign type
      const hasCampaignType = item.type && campaignTypes.includes(item.type);
      const hasCampaignStatus = item.status && campaignStatuses.includes(item.status);
      
      const issues = [];
      if (!item.type) {
        issues.push('Missing "type" field');
      } else if (!hasCampaignType) {
        issues.push(`Invalid "type": "${item.type}" (must be one of: ${campaignTypes.join(', ')})`);
      }
      
      if (!item.status) {
        issues.push('Missing "status" field');
      } else if (!hasCampaignStatus) {
        issues.push(`Invalid "status": "${item.status}" (must be one of: ${campaignStatuses.join(', ')})`);
      }
      
      if (issues.length > 0) {
        return { valid: false, reason: issues.join('; ') };
      }
      
      return { valid: true };
    }

    function findStablesBingo() {
      const output = document.getElementById('output');
      output.innerHTML = '<div class="section"><h2>Searching for "Stables bingo"...</h2></div>';
      
      const campaignsKey = 'local_repo:campaigns';
      const rawData = localStorage.getItem(campaignsKey);
      
      if (!rawData) {
        output.innerHTML = '<div class="section"><h2 class="invalid">‚ùå No campaigns data found in localStorage</h2></div>';
        return;
      }
      
      try {
        const allItems = JSON.parse(rawData);
        const stablesBingo = allItems.find(c => 
          c.name && c.name.toLowerCase().includes('stables bingo')
        );
        
        if (stablesBingo) {
          const validation = validateCampaign(stablesBingo);
          let html = '<div class="section">';
          html += '<h2 class="warning">üéØ FOUND "Stables bingo"</h2>';
          html += '<pre>' + JSON.stringify(stablesBingo, null, 2) + '</pre>';
          
          if (validation.valid) {
            html += '<p class="valid">‚úÖ VALIDATION: PASSED - Should appear in app</p>';
          } else {
            html += '<p class="invalid">‚ùå VALIDATION: FAILED</p>';
            html += '<p class="invalid">Reason: ' + validation.reason + '</p>';
            html += '<p class="warning"><strong>This is why it\'s missing from the app!</strong></p>';
            
            // Show how to fix
            html += '<div style="margin-top: 15px; padding: 10px; background: #1e1e1e; border-left: 3px solid #dcdcaa;">';
            html += '<strong>How to fix:</strong><br>';
            if (!stablesBingo.type || !campaignTypes.includes(stablesBingo.type)) {
              html += '1. Set "type" to one of: ' + campaignTypes.join(', ') + '<br>';
            }
            if (!stablesBingo.status || !campaignStatuses.includes(stablesBingo.status)) {
              html += '2. Set "status" to one of: ' + campaignStatuses.join(', ') + '<br>';
            }
            html += '</div>';
          }
          html += '</div>';
          output.innerHTML = html;
        } else {
          output.innerHTML = '<div class="section"><h2 class="invalid">‚ùå "Stables bingo" NOT FOUND in localStorage</h2><p>Total items in storage: ' + allItems.length + '</p></div>';
        }
      } catch (error) {
        output.innerHTML = '<div class="section"><h2 class="invalid">‚ùå Error parsing data</h2><p>' + error.message + '</p></div>';
      }
    }

    function runDiagnostic() {
      const output = document.getElementById('output');
      output.innerHTML = '<div class="section"><h2>Running diagnostic...</h2></div>';
      
      const campaignsKey = 'local_repo:campaigns';
      const rawData = localStorage.getItem(campaignsKey);
      
      let html = '';
      
      if (!rawData) {
        html += '<div class="section"><h2 class="invalid">‚ùå No campaigns data found</h2></div>';
      } else {
        try {
          const allItems = JSON.parse(rawData);
          html += '<div class="section"><h2>üì¶ RAW STORAGE</h2><p>Found <strong>' + allItems.length + '</strong> item(s)</p></div>';
          
          const validCampaigns = [];
          const invalidItems = [];
          
          allItems.forEach((item) => {
            const validation = validateCampaign(item);
            if (validation.valid) {
              validCampaigns.push(item);
            } else {
              invalidItems.push({ item, reason: validation.reason });
            }
          });
          
          html += '<div class="section">';
          html += '<h2 class="valid">‚úÖ VALID CAMPAIGNS: ' + validCampaigns.length + '</h2>';
          html += '<h2 class="invalid">‚ùå INVALID/FILTERED: ' + invalidItems.length + '</h2>';
          html += '</div>';
          
          // Show valid campaigns
          if (validCampaigns.length > 0) {
            html += '<div class="section"><h2>‚úÖ Valid Campaigns (appears in app)</h2>';
            validCampaigns.forEach((campaign, idx) => {
              html += '<div class="campaign-item campaign-valid">';
              html += '<strong>' + (idx + 1) + '. "' + (campaign.name || 'Unnamed') + '"</strong><br>';
              html += 'ID: ' + campaign.id + '<br>';
              html += 'Type: ' + campaign.type + '<br>';
              html += 'Status: ' + campaign.status + '<br>';
              html += '</div>';
            });
            html += '</div>';
          }
          
          // Show invalid items with details
          if (invalidItems.length > 0) {
            html += '<div class="section"><h2 class="invalid">‚ùå Invalid Items (filtered out)</h2>';
            invalidItems.forEach(({ item, reason }, idx) => {
              html += '<div class="campaign-item campaign-invalid">';
              html += '<strong>' + (idx + 1) + '. "' + (item.name || 'Unnamed') + '"</strong><br>';
              html += 'ID: ' + item.id + '<br>';
              html += '<span class="invalid">Reason: ' + reason + '</span><br>';
              html += '<details><summary>Full data</summary><pre>' + JSON.stringify(item, null, 2) + '</pre></details>';
              html += '</div>';
            });
            html += '</div>';
          }
          
          // Check for "Stables bingo"
          const stablesBingo = allItems.find(c => 
            c.name && c.name.toLowerCase().includes('stables bingo')
          );
          
          if (stablesBingo) {
            html += '<div class="section" style="border: 2px solid #dcdcaa;">';
            html += '<h2 class="warning">üéØ "Stables bingo" FOUND</h2>';
            const validation = validateCampaign(stablesBingo);
            if (!validation.valid) {
              html += '<p class="invalid">‚ùå VALIDATION FAILED: ' + validation.reason + '</p>';
            } else {
              html += '<p class="valid">‚úÖ Validation passed</p>';
            }
            html += '</div>';
          }
          
        } catch (error) {
          html += '<div class="section"><h2 class="invalid">‚ùå Error</h2><p>' + error.message + '</p></div>';
        }
      }
      
      output.innerHTML = html;
    }

    // Auto-run on load
    window.onload = () => {
      runDiagnostic();
    };
  </script>
</body>
</html>





